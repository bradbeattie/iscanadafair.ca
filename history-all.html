<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <link href="https://fonts.googleapis.com/css?family=Cinzel|Open+Sans" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="style.css">
        <style>
            .line {
                fill: none;
                stroke: black;
                stroke-width: 5px;
            }
            .liberal { stroke: lightcoral; }
            .canadianalliance { stroke: cadetblue; }
            .reform { stroke: mediumseagreen; }
            .conservative { stroke: cornflowerblue; }
            .socialcredit { stroke: lightgreen; }
            .ralliementcr√©ditiste { stroke: lightgreen; }
            .ccf { stroke: #EEDDAA; }
            .pc { stroke: #0d5d93; }
            .ndp { stroke: sandybrown; }
            .bq { stroke: lightskyblue; }
            .green { stroke: #2f873e; }
        </style>
    </head>
    <body id="app">
        <div class="section" id="section-1">
            <h1>&mdash; Canadian Proportionality &mdash;<br/><small>Comparing the ratio of seat % to vote %</small></h1>
            <p>The graph below tracks the proportionality in parliament of each party.<br/>The grey bar along the centre is proportionality +/- 5%.</p>
            <p>When a party has more seats than votes, they're above the grey bar.<br/>When they have more votes than seats, they're below.</p>
            <script src="https://d3js.org/d3.v4.min.js"></script>
            <script src="https://d3js.org/d3-selection-multi.v0.4.min.js"></script>
            <script>
var margin = {top: 10, right: 10, bottom: 30, left: 30};
var width = 650 - margin.left - margin.right;
var height = 350 - margin.top - margin.bottom;
var parseDate = d3.timeParse("%Y-%m-%d");
var x = d3.scaleTime().range([0, width]);
var y = d3.scaleLinear().range([height, 0]);
var valueline = d3.line()
    .x(function(d) { return  x(d.dateObj); })
    .y(function(d) { return y(d.proportionality); })
    //.curve(d3.curveStepAfter)

// append the svg obgect to the body of the page
// appends a 'group' element to 'svg'
// moves the 'group' element to the top left margin
var svg = d3.select("#section-1").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var markerRadius = 1.1
    svg.append("svg:defs").append("svg:marker")
        .attr("id", "lastElection")
        .attr("refX", markerRadius * 0.3)
        .attr("refY", markerRadius)
        .attr("markerWidth", markerRadius * 2)
        .attr("markerHeight", markerRadius * 2)
        .attr("orient", "auto")
        .append("circle")
        .attr("fill", "rgba(0,0,0,0.5)")
        .attr("r", markerRadius)
        .attr("cx", markerRadius)
        .attr("cy", markerRadius)

// Get the data
d3.tsv("history.tsv", function(error, rawData) {
    if (error) throw error;

    // format the data
    var parties = new Set([]);
    var years = new Set([]);
    rawData.forEach(function(d) {
        years.add(d.date);
        d.dateObj = parseDate(d.date);
        d.proportionality = d["Seat %"] / d["Vote %"];
        parties.add(d.Party);
    });
    years = Array.from(years).sort();
    years.push("2019-01-01");

    rawData = rawData.filter(function(d) {
        return d.dateObj.getFullYear() > 1970;
    });

    // Scale the range of the data
    x.domain([parseDate("1972-10-01"), parseDate(years[years.length - 1])]);
    y.domain([0, d3.max(rawData, function(d) { return d.proportionality; })]);

    svg.append("rect").attrs({
        "x" : 0,
        "width" : function(d){ return x(parseDate(years[years.length - 1])); },
        "y" : function(d){ return y(1.05);},
        "height" : function(d){ return y(1/1.05) - y(1.05);},
        "fill" : "rgba(0,0,0,0.1)",
        "shape-rendering" : "crispEdges",
    });

    parties.forEach(function(selectedParty) {
        var data = [];
        var latestD;
        rawData.filter(function(d) {
            return d.Party === selectedParty;
        }).forEach(function(d) {
            if (latestD) {
                data.push({
                    "proportionality": latestD.proportionality,
                    "dateObj": (new Date(d.dateObj.valueOf() * 0.9 + latestD.dateObj.valueOf() * 0.1)),
                })
            }
            data.push(d)
            latestD = d;
        });
        if (data.length) {
            var lastRecord = data[data.length - 1];
            data.push({
                "dateObj": parseDate(years[years.indexOf(lastRecord.date) + 1]),
                "proportionality": lastRecord.proportionality,
            })
            svg.append("path")
                .data([data])
                .attr("class", "line " + selectedParty.replace(" ", "").toLowerCase())
                .attr("d", valueline)
                .attr("marker-end", lastRecord.dateObj.getFullYear() !== 2015 ? "url(#lastElection)": "")
                .append("title").text(selectedParty)
        }
    });

    // Add the X Axis
    svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x));

    // Add the Y Axis
    svg.append("g")
        .call(d3.axisLeft(y));

    svg.selectAll("line.horizontalGrid").data(y.ticks(8)).enter()
        .append("line")
            .attrs({
                "class":"horizontalGrid",
                "x1" : 0,
                "x2" : width,
                "y1" : function(d){ return y(d);},
                "y2" : function(d){ return y(d);},
                "fill" : "none",
                "shape-rendering" : "crispEdges",
                "stroke" : "rgba(0,0,0,0.05)",
                "stroke-width" : "1px"
            });
    svg.selectAll("line.verticalGrid").data(x.ticks(20)).enter()
        .append("line")
            .attrs({
                "class":"verticalGrid",
                "y1" : 0,
                "y2" : height,
                "x1" : function(d){ return x(d);},
                "x2" : function(d){ return x(d);},
                "fill" : "none",
                "shape-rendering" : "crispEdges",
                "stroke" : "rgba(0,0,0,0.05)",
                "stroke-width" : "1px"
            });
});
            </script>
        </div>
        <div class="section" id="section-2">
            <h2>Points of interest</h2>
            <p>Note the significant dive of the PC party in 1993 corresponding with the appearance of the Reform party. This significant underrepresentation lasted 10 years until the 2003 merger. For historical context, see Stephen Harper's co-written 1997 article <a href="https://scribd.com/doc/51938443/Stephen-Harper-and-Tom-Flanagan-Our-Benign-Dictatorship-Next-City-Winter-1996-97">Our Benign Dictatorship</a>.</p>
            <p>Further, note the 2011 dive of the Liberal party and the sole instance of NDP over-proportionality. In this context, we see the 2015 Liberal platform <a href="https://iscanadafair.ca">explicitly calling to end first-past-the-post</a>. The subsequent election won them a majority and the ability to follow through with this promise.</p>
        </div>
    </body>
</html>
